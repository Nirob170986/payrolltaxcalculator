<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payroll Tax Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Lato', sans-serif;
            background-color: white;
        }
        .card {
            background-color: #FFF5E5;
            border-radius: 1.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            padding: 2rem;
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 25px 35px -5px rgba(0, 0, 0, 0.15), 0 15px 15px -5px rgba(0, 0, 0, 0.08);
        }
        .header {
            color: #1a202c;
            font-weight: 900;
        }
        .subheader {
            color: #4a5568;
            font-weight: 400;
        }
        @media (max-width: 640px) {
            .card {
                padding: 1rem;
            }
            .grid {
                grid-template-columns: 1fr;
            }
        }
        /* Print Styles */
        @media print {
            body {
                background-color: #fff;
                margin: 0;
                padding: 0;
                font-size: 12pt;
                color: #000;
            }
            .no-print {
                display: none !important;
            }
            .card, .card:hover {
                box-shadow: none !important;
                background-color: #fff !important;
                border: none !important;
                padding: 0 !important;
            }
            .print-only {
                display: block !important;
            }
            .print-layout {
                page-break-after: always;
                padding: 2cm;
            }
            .print-header {
                text-align: center;
                margin-bottom: 2rem;
            }
            table {
                width: 100%;
                border-collapse: collapse;
            }
            th, td {
                border: 1px solid #ccc;
                padding: 8px;
                text-align: left;
            }
            h1, h2, h3, h4 {
                margin: 0;
                padding: 0;
            }
            .page-break {
                page-break-after: always;
            }
        }
        .print-only {
            display: none;
        }
    </style>
</head>
<body class="bg-white p-6 min-h-screen flex items-center justify-center">
    <div class="max-w-6xl w-full">
        <!-- Main Header -->
        <div class="text-center mb-12 no-print">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-900 leading-tight">Your <span class="text-[#F37021] font-black">Payroll Tax</span> in Minutes</h1>
            <p class="mt-4 text-gray-600 max-w-2xl mx-auto text-sm sm:text-base">Get a full breakdown of your salary and a precise calculation of your monthly and annual taxes. Simply input your details below to get started.</p>
        </div>

        <!-- Top Input Fields & Calculate Button -->
        <div class="bg-white card flex flex-wrap items-center justify-center gap-6 mb-12 shadow-lg">
            <!-- Assessment Year Input -->
            <div class="flex flex-col items-start w-full sm:w-auto">
                <label for="assessment-year-select" class="text-sm font-semibold text-gray-700 mb-2">Assessment Year</label>
                <select id="assessment-year-select" class="bg-orange-50 border border-gray-300 rounded-full px-5 py-3 w-full sm:w-auto focus:outline-none focus:ring-2 focus:ring-[#F37021]">
                    <option>2026-2027</option>
                </select>
            </div>
            
            <!-- Monthly Salary Input -->
            <div class="flex flex-col items-start w-full sm:w-auto">
                <label for="monthly-income-input" class="text-sm font-semibold text-gray-700 mb-2">Monthly Salary</label>
                <input type="text" value="" id="monthly-income-input" class="bg-orange-50 border border-gray-300 rounded-full px-5 py-3 w-full sm:w-auto focus:outline-none focus:ring-2 focus:ring-[#F37021]" placeholder="Enter Salary">
            </div>

            <!-- Taxpayer Type Input -->
            <div class="flex flex-col items-start w-full sm:w-auto">
                <label for="city-corporation-select" class="text-sm font-semibold text-gray-700 mb-2">Tax Payer Type</label>
                <select id="city-corporation-select" class="bg-orange-50 border border-gray-300 rounded-full px-5 py-3 w-full sm:w-auto focus:outline-none focus:ring-2 focus:ring-[#F37021]">
                    <option value="" disabled selected>Select type</option>
                    <option>Regular</option>
                    <option>New Taxpayer</option>
                </select>
            </div>

            <!-- Gender Input -->
            <div class="flex flex-col items-start w-full sm:w-auto">
                <label for="gender-select" class="text-sm font-semibold text-gray-700 mb-2">Gender</label>
                <select id="gender-select" class="bg-orange-50 border border-gray-300 rounded-full px-5 py-3 w-full sm:w-auto focus:outline-none focus:ring-2 focus:ring-[#F37021]">
                    <option value="" disabled selected>Select Gender</option>
                    <option>Male</option>
                    <option>Female</option>
                </select>
            </div>

            <!-- Calculate Button -->
            <button id="calculate-button" class="bg-[#F37021] hover:bg-orange-600 text-white font-bold py-3 px-10 rounded-full shadow-lg transition duration-300 transform hover:scale-105 w-full sm:w-auto mt-6 sm:mt-0">
                Calculate
            </button>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
            <!-- Left Side Panels -->
            <div class="space-y-10">
                <!-- Monthly Payroll Breakdown Card -->
                <div class="card p-8">
                    <h2 class="text-xl font-bold text-gray-800 mb-6">Monthly Payroll Breakdown</h2>
                    <div class="flex justify-center mt-4 px-4 no-print">
                        <div id="payroll-bar-chart-container" class="w-full h-8 bg-gray-200 rounded-full overflow-hidden flex shadow-inner">
                            <div id="tax-portion" class="h-full bg-[#F37021]" style="width: 100%;"></div>
                            <div id="take-home-portion" class="h-full bg-[#d1d5db]" style="width: 0%;"></div>
                        </div>
                    </div>
                    <div class="mt-8 text-center space-y-3">
                        <p class="text-gray-600 font-semibold text-sm"><span class="inline-block w-4 h-4 rounded-full bg-[#F37021] mr-2 no-print"></span>Monthly Tax: <span id="monthly-tax-display" class="font-extrabold text-lg text-gray-900">---</span></p>
                        <p class="text-gray-600 font-semibold text-sm"><span class="inline-block w-4 h-4 rounded-full bg-[#d1d5db] mr-2 no-print"></span>Take Home: <span id="take-home-display" class="font-extrabold text-lg text-gray-900">---</span></p>
                        <p class="text-gray-600 font-semibold text-sm"><span class="inline-block w-4 h-4 rounded-full bg-gray-500 mr-2 no-print"></span>Monthly Income: <span id="monthly-income-display" class="font-extrabold text-lg text-gray-900">---</span></p>
                    </div>
                </div>

                <!-- Income Details Card -->
                <div class="card p-8">
                    <h2 class="text-xl font-bold text-gray-800 mb-6">Income Details</h2>
                    <div class="grid grid-cols-2 gap-4 mt-4">
                        <div class="bg-orange-50 p-4 rounded-xl text-center">
                            <p class="text-sm text-gray-600">Monthly Income</p>
                            <span id="income-monthly-detail" class="text-lg font-bold text-gray-800 mt-1 block">---</span>
                        </div>
                        <div class="bg-orange-50 p-4 rounded-xl text-center">
                            <p class="text-sm text-gray-600">Projected Annual Income</p>
                            <span id="income-annual-detail" class="text-lg font-bold text-gray-800 mt-1 block">---</span>
                        </div>
                    </div>
                    <div class="mt-6 space-y-4 no-print">
                        <button id="add-monthly-benefits" class="w-full bg-gray-100 text-gray-700 py-3 rounded-lg font-semibold border border-gray-200 hover:bg-gray-200 transition duration-300">+ Add Monthly Benefits</button>
                        <input type="text" id="monthly-benefits-input" class="hidden w-full bg-white border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-[#F37021]" placeholder="Enter monthly benefit amount">
                        
                        <button id="add-other-income" class="w-full bg-gray-100 text-gray-700 py-3 rounded-lg font-semibold border border-gray-200 hover:bg-gray-200 transition duration-300">+ Add Festival Bonus</button>
                        <input type="text" id="other-income-input" class="hidden w-full bg-white border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-[#F37021]" placeholder="Enter other income amount">

                        <button id="add-yearly-benefits" class="w-full bg-gray-100 text-gray-700 py-3 rounded-lg font-semibold border border-gray-200 hover:bg-gray-200 transition duration-300">+ Add Yearly Benefits</button>
                        <input type="text" id="yearly-benefits-input" class="hidden w-full bg-white border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-[#F37021]" placeholder="Enter yearly benefit amount">
                    </div>
                </div>

                <!-- Input Details Card -->
                <div class="card p-8 no-print">
                    <h2 class="text-xl font-bold text-gray-800 mb-6">Input Details</h2>
                    <div class="mt-4 space-y-4">
                        <button id="add-investment-amount" class="w-full bg-gray-100 text-gray-700 py-3 rounded-lg font-semibold border border-gray-200 hover:bg-gray-200 transition duration-300">+ Actual investment amount</button>
                        <input type="text" id="investment-input" class="hidden w-full bg-white border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-[#F37021]" placeholder="Enter allowable investment amount">

                        <button id="add-advance-tax" class="w-full bg-gray-100 text-gray-700 py-3 rounded-lg font-semibold border border-gray-200 hover:bg-gray-200 transition duration-300">+ Add Advance Income Tax Paid</button>
                        <input type="text" id="advance-tax-input" class="hidden w-full bg-white border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-[#F37021]" placeholder="Enter advance tax paid">
                    </div>
                </div>
            </div>

            <!-- Right Side Panels -->
            <div class="space-y-10">
                <!-- Total Taxable Income Card -->
                <div class="card p-8">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-gray-800">Total Taxable Income</h2>
                        <span id="total-taxable-income-display" class="text-2xl font-bold text-gray-600">---</span>
                    </div>
                    <p class="text-base font-semibold text-gray-800 mb-4">Total Annual Income: <span id="total-annual-income-display">---</span></p>
                    <div id="taxable-income-details" class="bg-orange-50 p-6 rounded-xl hidden">
                        <h3 class="font-bold text-gray-800 text-center mb-4 text-lg">Taxable Income</h3>
                        <table class="w-full text-left">
                            <thead>
                                <tr class="border-b-2 border-gray-300 text-gray-600">
                                    <th class="py-3">Condition</th>
                                    <th class="py-3 text-right">Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="text-gray-800">
                                    <td class="py-2">Projected Annual Income</td>
                                    <td class="py-2 text-right" id="annual-income-exemption"></td>
                                </tr>
                                <tr class="text-gray-800">
                                    <td class="py-2">Less: Lower of:</td>
                                    <td class="py-2 text-right"></td>
                                </tr>
                                <tr class="text-gray-800">
                                    <td class="py-2 pl-4">1/3 of Projected Annual Income</td>
                                    <td class="py-2 text-right" id="exemption-third"></td>
                                </tr>
                                <tr class="text-gray-800">
                                    <td class="py-2 pl-4">Maximum limit</td>
                                    <td class="py-2 text-right">500,000</td>
                                </tr>
                                <tr class="font-bold text-gray-800 border-t-2 border-gray-300 mt-4">
                                    <td class="py-3">Total Taxable Income</td>
                                    <td class="py-3 text-right"><span id="taxable-income-value">---</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <a href="#" id="hide-taxable-income" class="text-[#F37021] hover:underline text-sm block mx-auto mt-4 transition duration-300 no-print">Show Calculation</a>
                </div>

                <!-- Total Income Tax Liability Card -->
                <div class="card p-8">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-gray-800">Total Income Tax Liability</h2>
                        <span id="total-tax-liability-display" class="text-2xl font-bold text-gray-600">---</span>
                    </div>
                    <div id="tax-liability-details" class="bg-orange-50 p-6 rounded-xl hidden">
                        <h3 class="font-bold text-gray-800 text-center mb-4 text-lg">Calculation Of Income Tax Liability</h3>
                        <table class="w-full text-left">
                            <thead>
                                <tr class="border-b-2 border-gray-300 text-gray-600">
                                    <th class="py-3">Slabs</th>
                                    <th class="py-3">Taxable Income</th>
                                    <th class="py-3">Tax Rate</th>
                                    <th class="py-3 text-right">Taxable Amount</th>
                                </tr>
                            </thead>
                            <tbody id="tax-slabs-body">
                                <!-- Data will be populated here by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    <a href="#" id="hide-tax-liability" class="text-[#F37021] hover:underline text-sm block mx-auto mt-4 transition duration-300 no-print">Show Breakdown</a>
                </div>

                <!-- Tax Rebate on Investment Card -->
                <div class="card p-8">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-gray-800">Tax Rebate on Investment</h2>
                        <span id="tax-credit-display" class="text-2xl font-bold text-gray-600">---</span>
                    </div>
                    <div id="tax-credit-details" class="bg-orange-50 p-6 rounded-xl hidden">
                        <h3 class="font-bold text-gray-800 text-center mb-4 text-lg">Calculation Of Tax Rebate On Investment</h3>
                        <table class="w-full text-left">
                            <thead>
                                <tr class="border-b-2 border-gray-300 text-gray-600">
                                    <th class="py-3">#</th>
                                    <th class="py-3">Details</th>
                                    <th class="py-3">Eligible Investments</th>
                                    <th class="py-3 text-right">Amount</th>
                                    <th class="py-3 text-right">Credit Amount</th>
                                </tr>
                            </thead>
                            <tbody id="tax-credit-body">
                                <tr class="text-gray-800">
                                    <td class="py-2">a</td>
                                    <td class="py-2">3% of total income</td>
                                    <td id="credit-a-val" class="py-2"></td>
                                    <td class="py-2 text-right"></td>
                                    <td class="py-2 text-right"></td>
                                </tr>
                                <tr class="text-gray-800">
                                    <td class="py-2">b</td>
                                    <td class="py-2">15% of the allowable investment</td>
                                    <td id="credit-b-val" class="py-2"></td>
                                    <td class="py-2 text-right"></td>
                                    <td class="py-2 text-right"></td>
                                </tr>
                                <tr class="text-gray-800">
                                    <td class="py-2">c</td>
                                    <td class="py-2">Maximum allowable limit</td>
                                    <td id="credit-c-val" class="py-2">1,000,000</td>
                                    <td class="py-2 text-right"></td>
                                    <td class="py-2 text-right"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <a href="#" id="hide-tax-credit" class="text-[#F37021] hover:underline text-sm block mx-auto mt-4 transition duration-300 no-print">Show Calculation</a>
                </div>

                <!-- Income Tax Payable Card -->
                <div class="card p-8">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-gray-800">Income Tax Payable</h2>
                        <span id="tax-payable-display" class="text-2xl font-bold text-gray-600">---</span>
                    </div>
                    <div id="tax-payable-details" class="bg-orange-50 p-6 rounded-xl hidden">
                        <h3 class="font-bold text-gray-800 text-center mb-4 text-lg">Income Tax Payable</h3>
                        <table class="w-full text-left">
                            <thead>
                                <tr class="border-b-2 border-gray-300 text-gray-600">
                                    <th class="py-3">Details</th>
                                    <th class="py-3 text-right">Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="text-gray-800">
                                    <td class="py-2">Total income tax payable</td>
                                    <td id="total-tax-payable-amount" class="py-2 font-semibold text-right">---</td>
                                </tr>
                                <tr class="text-gray-800">
                                    <td class="py-2">Less: Advance income tax</td>
                                    <td id="advance-tax-amount" class="py-2 font-semibold text-right">---</td>
                                </tr>
                                <tr class="text-gray-800 font-bold border-t-2 border-gray-300 mt-4">
                                    <td class="py-3">Remaining tax liability</td>
                                    <td id="remaining-tax-amount" class="py-3 font-semibold text-right">---</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <a href="#" id="hide-tax-payable" class="text-[#F37021] hover:underline text-sm block mx-auto mt-4 transition duration-300 no-print">Show Calculation</a>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const monthlyIncomeInput = document.getElementById('monthly-income-input');
            const calculateButton = document.getElementById('calculate-button');
            const citySelect = document.getElementById('city-corporation-select');
            const genderSelect = document.getElementById('gender-select');
            
            const monthlyTaxDisplay = document.getElementById('monthly-tax-display');
            const takeHomeDisplay = document.getElementById('take-home-display');
            const monthlyIncomeDisplay = document.getElementById('monthly-income-display');
            const incomeMonthlyDetail = document.getElementById('income-monthly-detail');
            const incomeAnnualDetail = document.getElementById('income-annual-detail');
            const totalTaxableIncomeDisplay = document.getElementById('total-taxable-income-display');
            const totalAnnualIncomeDisplay = document.getElementById('total-annual-income-display');
            const taxableIncomeValue = document.getElementById('taxable-income-value');
            const totalTaxLiabilityDisplay = document.getElementById('total-tax-liability-display');
            const taxSlabsBody = document.getElementById('tax-slabs-body');
            const totalTaxPayableAmount = document.getElementById('total-tax-payable-amount');
            const advanceTaxAmount = document.getElementById('advance-tax-amount');
            const remainingTaxAmount = document.getElementById('remaining-tax-amount');
            const taxCreditDisplay = document.getElementById('tax-credit-display');
            const annualIncomeExemption = document.getElementById('annual-income-exemption');


            const hideTaxableIncomeLink = document.getElementById('hide-taxable-income');
            const hideTaxLiabilityLink = document.getElementById('hide-tax-liability');
            const hideTaxCreditLink = document.getElementById('hide-tax-credit');
            const hideTaxPayableLink = document.getElementById('hide-tax-payable');

            const taxableIncomeDetails = document.getElementById('taxable-income-details');
            const taxLiabilityDetails = document.getElementById('tax-liability-details');
            const taxCreditDetails = document.getElementById('tax-credit-details');
            const taxPayableDetails = document.getElementById('tax-payable-details');

            // New benefit and investment inputs
            const monthlyBenefitsButton = document.getElementById('add-monthly-benefits');
            const monthlyBenefitsInput = document.getElementById('monthly-benefits-input');
            const otherIncomeButton = document.getElementById('add-other-income');
            const otherIncomeInput = document.getElementById('other-income-input');
            const yearlyBenefitsButton = document.getElementById('add-yearly-benefits');
            const yearlyBenefitsInput = document.getElementById('yearly-benefits-input');
            const investmentButton = document.getElementById('add-investment-amount');
            const investmentInput = document.getElementById('investment-input');
            const advanceTaxButton = document.getElementById('add-advance-tax');
            const advanceTaxInput = document.getElementById('advance-tax-input');
            
            const MINIMUM_TAX = {
                'Regular': 5000,
                'New Taxpayer': 1000,
            };

            const NIL_TAX_THRESHOLDS = {
                'Male': 375000,
                'Female': 425000,
            };

            // Function to update the horizontal bar chart
            function updateBarChart(monthlyTax, totalMonthlyIncome) {
                const taxPortion = document.getElementById('tax-portion');
                const takeHomePortion = document.getElementById('take-home-portion');

                if (totalMonthlyIncome > 0) {
                    const taxPercentage = (monthlyTax / totalMonthlyIncome) * 100;
                    const takeHomePercentage = 100 - taxPercentage;
                    taxPortion.style.width = `${taxPercentage}%`;
                    takeHomePortion.style.width = `${takeHomePercentage}%`;
                } else {
                    taxPortion.style.width = '0%';
                    takeHomePortion.style.width = '100%';
                }
            }


            // Function to perform calculations and update the UI
            function updateCalculations() {
                const monthlyIncome = parseFloat(monthlyIncomeInput.value) || 0;
                const monthlyBenefits = parseFloat(monthlyBenefitsInput.value) || 0;
                const otherIncome = parseFloat(otherIncomeInput.value) || 0;
                const yearlyBenefits = parseFloat(yearlyBenefitsInput.value) || 0;
                const investmentAmount = parseFloat(investmentInput.value) || 0;
                const advanceTaxPaid = parseFloat(advanceTaxInput.value) || 0;
                const gender = genderSelect.value;
                const totalMonthlyIncome = monthlyIncome + monthlyBenefits;

                // Check for valid income input
                if (monthlyIncome === 0) {
                    const placeholders = ['monthly-tax-display', 'take-home-display', 'monthly-income-display', 'income-monthly-detail', 'income-annual-detail', 'total-taxable-income-display', 'total-annual-income-display', 'taxable-income-value', 'total-tax-liability-display', 'total-tax-payable-amount', 'advance-tax-amount', 'remaining-tax-amount', 'tax-credit-display', 'annual-income-exemption', 'exemption-third', 'credit-a-val', 'credit-b-val'];
                    placeholders.forEach(id => {
                        const element = document.getElementById(id);
                        if (element) {
                            element.textContent = '---';
                        }
                    });
                    taxSlabsBody.innerHTML = '';
                    updateBarChart(0, 0);
                    return;
                }

                const annualIncome = (totalMonthlyIncome * 12) + yearlyBenefits + otherIncome;
                const selectedCity = citySelect.value;
                const minimumTaxAmount = MINIMUM_TAX[selectedCity];
                const nilTaxLimit = NIL_TAX_THRESHOLDS[gender];

                // Calculate the exemption amount based on the new rule
                const exemptionAmount = Math.min(annualIncome / 3, 500000);

                // Calculate Total Taxable Income
                const taxableIncome = Math.max(0, annualIncome - exemptionAmount);

                let remainingTaxableIncome = taxableIncome;
                let calculatedTax = 0;
                let taxSlabData = '';

                // Add Nil Tax slab based on gender
                const nilTaxAmount = Math.min(nilTaxLimit, taxableIncome);
                taxSlabData += `
                    <tr class="text-gray-800">
                        <td class="py-2">On the first ৳${nilTaxLimit.toLocaleString('en-US')} (Nil tax)</td>
                        <td class="py-2">${nilTaxAmount.toLocaleString('en-US')}</td>
                        <td class="py-2">0%</td>
                        <td class="py-2 text-right">0</td>
                    </tr>
                `;
                remainingTaxableIncome -= nilTaxAmount;

                // Apply other slabs only if there's remaining income
                if (remainingTaxableIncome > 0) {
                    let currentLimit = 300000;
                    let taxRate = 0.10;

                    // First slab (10%)
                    let amountThisSlab = Math.min(currentLimit, remainingTaxableIncome);
                    calculatedTax += amountThisSlab * taxRate;
                    taxSlabData += `
                        <tr class="text-gray-800">
                            <td class="py-2">On the next ৳${currentLimit.toLocaleString('en-US')}</td>
                            <td class="py-2">${amountThisSlab.toLocaleString('en-US')}</td>
                            <td class="py-2">10%</td>
                            <td class="py-2 text-right">${(amountThisSlab * taxRate).toLocaleString('en-US')}</td>
                        </tr>
                    `;
                    remainingTaxableIncome -= amountThisSlab;

                    if (remainingTaxableIncome > 0) {
                        currentLimit = 400000;
                        taxRate = 0.15;
                        amountThisSlab = Math.min(currentLimit, remainingTaxableIncome);
                        calculatedTax += amountThisSlab * taxRate;
                        taxSlabData += `
                            <tr class="text-gray-800">
                                <td class="py-2">On the next ৳${currentLimit.toLocaleString('en-US')}</td>
                                <td class="py-2">${amountThisSlab.toLocaleString('en-US')}</td>
                                <td class="py-2">15%</td>
                                <td class="py-2 text-right">${(amountThisSlab * taxRate).toLocaleString('en-US')}</td>
                            </tr>
                        `;
                        remainingTaxableIncome -= amountThisSlab;
                    }

                    if (remainingTaxableIncome > 0) {
                        currentLimit = 500000;
                        taxRate = 0.20;
                        amountThisSlab = Math.min(currentLimit, remainingTaxableIncome);
                        calculatedTax += amountThisSlab * taxRate;
                        taxSlabData += `
                            <tr class="text-gray-800">
                                <td class="py-2">On the next ৳${currentLimit.toLocaleString('en-US')}</td>
                                <td class="py-2">${amountThisSlab.toLocaleString('en-US')}</td>
                                <td class="py-2">20%</td>
                                <td class="py-2 text-right">${(amountThisSlab * taxRate).toLocaleString('en-US')}</td>
                            </tr>
                        `;
                        remainingTaxableIncome -= amountThisSlab;
                    }
                    if (remainingTaxableIncome > 0) {
                        currentLimit = 2000000;
                        taxRate = 0.25;
                        amountThisSlab = Math.min(currentLimit, remainingTaxableIncome);
                        calculatedTax += amountThisSlab * taxRate;
                        taxSlabData += `
                            <tr class="text-gray-800">
                                <td class="py-2">On the next ৳${currentLimit.toLocaleString('en-US')}</td>
                                <td class="py-2">${amountThisSlab.toLocaleString('en-US')}</td>
                                <td class="py-2">25%</td>
                                <td class="py-2 text-right">${(amountThisSlab * taxRate).toLocaleString('en-US')}</td>
                            </tr>
                       
                        `;
                        remainingTaxableIncome -= amountThisSlab;
                    }
                    if (remainingTaxableIncome > 0) {
                        taxRate = 0.30;
                        amountThisSlab = remainingTaxableIncome;
                        calculatedTax += amountThisSlab * taxRate;
                        taxSlabData += `
                            <tr class="text-gray-800">
                                <td class="py-2">On rest of the income</td>
                                <td class="py-2">${amountThisSlab.toLocaleString('en-US')}</td>
                                <td class="py-2">30%</td>
                                <td class="py-2 text-right">${(amountThisSlab * taxRate).toLocaleString('en-US')}</td>
                            </tr>
                        `;
                        remainingTaxableIncome -= amountThisSlab;
                    }
                }

                let finalTotalTax = 0;
                let taxCredit = 0;
                let investmentTaxCredit = 0;
                
                // Apply the new tax logic
                if (taxableIncome <= nilTaxLimit) {
                    finalTotalTax = 0;
                } else {
                    if (calculatedTax < minimumTaxAmount) {
                        finalTotalTax = minimumTaxAmount;
                        taxCredit = 0;
                    } else {
                        finalTotalTax = calculatedTax;
                        const taxCreditA = 0.03 * annualIncome;
                        const taxCreditB = 0.15 * investmentAmount;
                        const taxCreditC = 1000000;
                        investmentTaxCredit = Math.min(taxCreditA, taxCreditB, taxCreditC);
                        taxCredit = investmentTaxCredit;
                    }
                }

                const totalTaxBeforeAdvance = finalTotalTax - taxCredit;
                const remainingTaxLiability = Math.max(0, totalTaxBeforeAdvance - advanceTaxPaid);
                const monthlyTax = remainingTaxLiability / 12;
                const takeHome = totalMonthlyIncome - monthlyTax;

                // Update displays
                monthlyIncomeDisplay.textContent = `BDT ${totalMonthlyIncome.toLocaleString('en-US')}`;
                incomeMonthlyDetail.textContent = totalMonthlyIncome.toLocaleString('en-US');
                incomeAnnualDetail.textContent = annualIncome.toLocaleString('en-US');
                totalAnnualIncomeDisplay.textContent = annualIncome.toLocaleString('en-US');
                totalTaxableIncomeDisplay.textContent = `৳ ${taxableIncome.toLocaleString('en-US')}`;
                taxableIncomeValue.textContent = taxableIncome.toLocaleString('en-US');
                annualIncomeExemption.textContent = annualIncome.toLocaleString('en-US');
                document.getElementById('exemption-third').textContent = (annualIncome/3).toLocaleString('en-US');

                totalTaxLiabilityDisplay.textContent = `৳ ${finalTotalTax.toLocaleString('en-US')}`;
                taxSlabsBody.innerHTML = taxSlabData;

                monthlyTaxDisplay.textContent = `BDT ${monthlyTax.toFixed(2).toLocaleString('en-US')}`;
                takeHomeDisplay.textContent = `BDT ${takeHome.toFixed(2).toLocaleString('en-US')}`;

                totalTaxPayableAmount.textContent = totalTaxBeforeAdvance.toLocaleString('en-US');
                advanceTaxAmount.textContent = `(${advanceTaxPaid.toLocaleString('en-US')})`;
                remainingTaxAmount.textContent = remainingTaxLiability.toLocaleString('en-US');
                taxCreditDisplay.textContent = `৳ ${taxCredit.toLocaleString('en-US')}`;
                totalTaxPayableAmount.textContent = totalTaxBeforeAdvance.toLocaleString('en-US');
                document.getElementById('tax-payable-display').textContent = `৳ ${remainingTaxLiability.toLocaleString('en-US')}`;

                // Update tax credit table
                if (investmentTaxCredit > 0) {
                    document.getElementById('credit-a-val').textContent = taxCreditA.toLocaleString('en-US');
                    document.getElementById('credit-b-val').textContent = taxCreditB.toLocaleString('en-US');
                } else {
                    document.getElementById('credit-a-val').textContent = 'N/A';
                    document.getElementById('credit-b-val').textContent = 'N/A';
                }
                document.getElementById('credit-c-val').textContent = 1000000;
                
                updateBarChart(monthlyTax, totalMonthlyIncome);
            }

            // Toggle functionality
            function setupToggle(buttonId, inputId) {
                const button = document.getElementById(buttonId);
                const input = document.getElementById(inputId);
                button.addEventListener('click', (e) => {
                    e.preventDefault();
                    input.classList.toggle('hidden');
                });
            }

            function setupHideToggle(linkId, contentId) {
                const link = document.getElementById(linkId);
                const content = document.getElementById(contentId);
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (content.classList.contains('hidden')) {
                        content.classList.remove('hidden');
                        link.textContent = 'Hide Calculation';
                    } else {
                        content.classList.add('hidden');
                        link.textContent = 'Show Calculation';
                    }
                });
            }

            // Initial calculation and chart drawing
            updateCalculations();
            
            calculateButton.addEventListener('click', updateCalculations);
            
            // Set up benefit and investment toggles
            setupToggle('add-monthly-benefits', 'monthly-benefits-input');
            setupToggle('add-other-income', 'other-income-input');
            setupToggle('add-yearly-benefits', 'yearly-benefits-input');
            setupToggle('add-investment-amount', 'investment-input');
            setupToggle('add-advance-tax', 'advance-tax-input');

            // Set up hide/show toggles
            setupHideToggle('hide-taxable-income', 'taxable-income-details');
            setupHideToggle('hide-tax-liability', 'tax-liability-details');
            setupHideToggle('hide-tax-credit', 'tax-credit-details');
            setupHideToggle('hide-tax-payable', 'tax-payable-details');
            
            // Handle the initial state of the collapsible sections
            taxableIncomeDetails.classList.add('hidden');
            taxLiabilityDetails.classList.add('hidden');
            taxCreditDetails.classList.add('hidden');
            taxPayableDetails.classList.add('hidden');

            monthlyIncomeInput.addEventListener('input', updateCalculations);
            monthlyBenefitsInput.addEventListener('input', updateCalculations);
            otherIncomeInput.addEventListener('input', updateCalculations);
            yearlyBenefitsInput.addEventListener('input', updateCalculations);
            investmentInput.addEventListener('input', updateCalculations);
            advanceTaxInput.addEventListener('input', updateCalculations);
            citySelect.addEventListener('change', updateCalculations);
            genderSelect.addEventListener('change', updateCalculations);
        });
    </script>
</body>
</html>
